---
title: "R Notebook"
output: html_notebook
---

Read data files with G23 all promoters
```{r}
library(dplyr)

DNA_barcodes <- read.csv("DNA_barcodes_soil.csv", header = T)
RNA_barcodes <- read.csv("RNA_barcodes_soil.csv", header = T)

df_barcodes <- left_join(DNA_barcodes, RNA_barcodes, by = c("seqnames",	"promoters",	"barcodes",	"group",	"strand",	"start",	"end",	"length",	"locus_tag.refseq",	"locus_tag.genbank", "Gene.ID.genbank",	"product.refseq",	"product.genbank",	"product.COG",	"Function",	"COG.category",	"KEGG_OID"))


df_barcodes[is.na(df_barcodes)] <- 0

df_barcodes1 <- df_barcodes
for(i in 19:ncol(df_barcodes1)) {  
  df_barcodes1[ , i] <- df_barcodes1[ , i] / sum(df_barcodes1[ , i]) 
  sum(df_barcodes1[ , i])
}

summarydf <- df_barcodes1 %>%
  group_by(seqnames, promoters,	group,	strand,	start,	end,	length,	locus_tag.refseq,	locus_tag.genbank,	
                              Gene.ID.genbank,	product.refseq,	product.genbank,	product.COG,	Function,	COG.category,	KEGG_OID) %>% 
  summarise(across(3:55, sum)) #3 is fixed, 57 = ncol(df_barcodes1) -6


summarydf$S_W1_R1 <- summarydf$RNA_S_W1_R1.fasta / summarydf$DNA_S_W1_R1.fasta
summarydf$S_W1_R2 <- summarydf$RNA_S_W1_R2.fasta / summarydf$DNA_S_W1_R2.fasta
summarydf$S_W1_R3 <- summarydf$RNA_S_W1_R3.fasta / summarydf$DNA_S_W1_R3.fasta
summarydf$S_W3_R1 <- summarydf$RNA_S_W3_R1.fasta / summarydf$DNA_S_W3_R1.fasta
summarydf$S_W3_R2 <- summarydf$RNA_S_W3_R2.fasta / summarydf$DNA_S_W3_R2.fasta
summarydf$S_W3_R3 <- summarydf$RNA_S_W3_R3.fasta / summarydf$DNA_S_W3_R3.fasta
summarydf$D7_R1 <- summarydf$RNA_D7_R1.fasta / summarydf$DNA_D7_R1.fasta
summarydf$D7_R2 <- summarydf$RNA_D7_R2.fasta / summarydf$DNA_D7_R2.fasta
summarydf$D7_R3 <- summarydf$RNA_D7_R3.fasta / summarydf$DNA_D7_R3.fasta
summarydf$D7_R4 <- summarydf$RNA_D7_R4.fasta / summarydf$DNA_D7_R4.fasta


summarydf$S_W1 <- (summarydf$S_W1_R1+summarydf$S_W1_R2+summarydf$S_W1_R3)/3
summarydf$S_W3 <- (summarydf$S_W3_R1+summarydf$S_W3_R2+summarydf$S_W3_R3)/3
summarydf$D7 <- (summarydf$D7_R1+summarydf$D7_R2+summarydf$D7_R3+summarydf$D7_R4)/4
```


```{r}
# Remove genes where any of S_W1, S_W2, or S_W3 is 0 (after log2 TPM transformation)
summarydf <- summarydf[!(summarydf$S_W1 == 0 | summarydf$S_W3 == 0), ]

# Load libraries
library(edgeR)
library(limma)
library(dplyr)

# Extract promoter and count columns from summarydf
Counts <- summarydf %>%
  ungroup() %>%
  select(promoters,
         S_W1_R1, S_W1_R2, S_W1_R3,
         S_W3_R1, S_W3_R2, S_W3_R3,
         D7_R1, D7_R2, D7_R3, D7_R4)

# Convert to data frame and set row names
Counts <- as.data.frame(Counts)
rownames(Counts) <- Counts[, 1]
Counts[, 1] <- NULL

# Create DGEList object
dge <- DGEList(counts = Counts)

# Assign group information
group <- factor(c("S_W1", "S_W1", "S_W1",
                  "S_W3", "S_W3", "S_W3",
                  "D7", "D7", "D7", "D7"))
dge$samples$group <- group


# Recalculate normalization factors
dge <- calcNormFactors(dge)

# Design matrix
design <- model.matrix(~ 0 + group)
colnames(design) <- gsub("group", "", colnames(design))

# Contrast matrix
contr.matrix <- makeContrasts(
  S_W1vsS_W3 = S_W3 - S_W1,
  S_W1vsD7 = S_W1 - D7,
  levels = colnames(design)
)

# Apply voom transformation
v <- voom(dge, design, plot = TRUE)

# Fit linear model
fit <- lmFit(v, design)
fit <- contrasts.fit(fit, contrasts = contr.matrix)
fit <- eBayes(fit, trend = TRUE, robust = TRUE)

# Plot mean-variance trend
plotSA(fit)

# Statistical test result
result <- decideTests(fit, adjust.method = "BH", lfc = 1, p.value = 0.05)
summary(result)
```



```{r}
# Load required libraries
library(dplyr)
library(ggplot2)
library(ggrepel)

# Extract differential expression results
res_S_W1vsD7 <- topTable(fit, coef = "S_W1vsD7", number = Inf, sort.by = "P")
res_S_W1vsD7$promoters <- rownames(res_S_W1vsD7)


# Join product annotations
res_S_W1vsD7 <- left_join(
  res_S_W1vsD7,
  summarydf[, c("promoters", "product.refseq")],
  by = "promoters"
)


# Categorize regulation
res_S_W1vsD7 <- res_S_W1vsD7 %>%
  mutate(
    regulation = case_when(
      adj.P.Val < 0.05 & logFC > 1 ~ "Up",
      adj.P.Val < 0.05 & logFC < -1 ~ "Down",
      TRUE ~ "NS"
    )
  )


# Define colors
volcano_colors <- c("Up" = "red", "Down" = "blue", "NS" = "gray")

# --- Define promoter sequences to label ---
down_promoters <- c(
  "TTCGTCCTGCTGGAGCATAACGTGCTGGTAAAACGAAGCCTGGCAGTGATTCATGCTCAAAATTCAACGGTGAACGCCTGATAACAGGCAAAAAATCCTCCAGCACCGACATAAACTGGAAAAAAACGCCGGAGGTGCCC",
  "TCACAAATTTTCCTTTTCCCGCCCTTCGATGAGTTTTTTCAATCGAAGTCGGCTGGCTGCGCGCGCGTTTATCAGCTACCATTTTCGCAAATGAACATTAATGTTCGAATTCCAAGACAAAAAAATCGCGAGGCCAGCCG",
  "AGGCGTGCCCCACAAGCCCTACTACTAAGGGAGGAGAGGGCGGCCACCAAAGCAGCATACGGCCCATGTCCCGGGGTTTCTAAGATGGTTGCCATAGCCTCTGCAATGAGGTTTTGCGTGCAATCCTGAGGGCAAAAATA",
  "ATGTGAACTCCTTCTGAAAAGCCGCGCAGTTTAACCTTCAGCCACAACACTGCGTACAAGAAAGCGCGCAAGCCTTGCCATAGAGCCTGTTGTTGGGTGACTCTCTAGTCATGTTTTGCAACTATTCCAGGGGTAGTGAC",
  "CCCAGCATGCGGCGTTGCGCAAAAAGGGCTGACGGCGGCAAAAACTACTACTTTAGTACTGGTTTTCCTGTCTATCGTCGCATTCCCAAGGGCTCGGGACTCACGTGTAATGCGCGCATAACGATAAGGATCGCCCTGCC",
  "GTTTGCTGCGCAAGCCGCCGGTGGCACGTTAAAAAAGTCCATGAACTCTATTGGGTTTAAATCCTCTGATAGGAGGAAATACGCCCCGACTCGCGTTAAACTGCGCGGGTTTTCAAGCCCCCCATTTTCCGGAGCCTTAC",
  "GTTCACCCCGTCGCATTCCCCGCCAGACCCGCCGTGACCGCCTAAGCTTCTGGTCAGCGAGCAGCCCTGCCCACGCATGTGAATGCAGGGCTGGCAAATGGATTTTTCCACCACAAGAAGACGCGACGAGGTTTACTTCC")

up_promoters <- c(
  "CGGAAATAAATCACCCGCCTCTTCAGATCGACCACTCAGCAGTTCGCATCAGCCGCTCTTGACAACCCATCAAGTCATCGGCATGATTCGCGGCCTATTTTGTTTGCTATTTCCTAAAAAGTCTTTCGAGGAGCTCGACG"
)

# Combine for labeling
label_promoters <- c(down_promoters, up_promoters)

# Subset data for labeling
label_genes <- res_S_W1vsD7 %>% filter(promoters %in% label_promoters)

# Volcano plot
ggplot(res_S_W1vsD7, aes(x = logFC, y = -log10(adj.P.Val), color = regulation)) +
  geom_point(alpha = 0.6) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "black") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black") +
  scale_color_manual(values = volcano_colors) +
  scale_x_continuous(limits = c(-5, 5), breaks = seq(-5, 5, 1)) +
  geom_text_repel(
    data = label_genes,
    aes(label = product.refseq),
    size = 4,               # ← enlarged gene label text
    box.padding = 0.5,
    max.overlaps = Inf
  ) +
  theme_minimal() +
  labs(
    title = "Volcano Plot: S_W1 vs D7",
    x = "log2 Fold Change",
    y = "-log10 Adjusted P-value"
  ) +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 20),    # ← larger legend
    axis.title = element_text(size = 20),     # ← larger axis labels
    axis.text = element_text(size = 20),      # ← larger axis ticks
    plot.title = element_text(size = 20, hjust = 0.5)  # ← larger centered title
  )




# 1. Filter for upregulated genes
res_SW1vsD7_up <- res_S_W1vsD7 %>% 
  filter(regulation == "Up")

res_SW1vsD7_down <- res_S_W1vsD7 %>% 
  filter(regulation == "Down")

write.csv(res_SW1vsD7_up, file = "res_SW1vsD7_up.csv", na="")
write.csv(res_SW1vsD7_down, file = "res_SW1vsD7_down.csv", na="")

```



```{r}
# Load required libraries
library(dplyr)
library(ggplot2)
library(ggrepel)

# Extract differential expression results
res_S_W1vsS_W3 <- topTable(fit, coef = "S_W1vsS_W3", number = Inf, sort.by = "P")
res_S_W1vsS_W3$promoters <- rownames(res_S_W1vsS_W3)


# Join product annotations
res_S_W1vsS_W3 <- left_join(
  res_S_W1vsS_W3,
  summarydf[, c("promoters", "product.refseq")],
  by = "promoters"
)


# Categorize regulation
res_S_W1vsS_W3 <- res_S_W1vsS_W3 %>%
  mutate(
    regulation = case_when(
      adj.P.Val < 0.05 & logFC > 1 ~ "Up",
      adj.P.Val < 0.05 & logFC < -1 ~ "Down",
      TRUE ~ "NS"
    )
  )


# Define colors
volcano_colors <- c("Up" = "red", "Down" = "blue", "NS" = "gray")

# --- Define promoter sequences to label ---

up_promoters <- c(
"GCCGCTGCTGGCGTGAACTAACGCCGACAGCAACGTACAAACGCCCCGACTGGTTCGGGGCGTTTGCGTTTCTGGCGCATTACTTTGGCAGCTTTTGTTTTACAGTAAGTGAATAGGTTGTAACGCTTGCAGGAGGTTAT",
"CTTTGGCTGGTAGATTGTGTTGATAAGTCTGATAGCCTAAAGTTGTATACAATCTGTTGATTCAGATCATAAGAATTCCTGCCTGCTTCAGGCACCCTTGTCGCAATTCGCGTTTTCTAAACCCTGCCTTGGAGATTCAC",
"CGGACCTTTTTTACCCACTGTGGGTTCTATTGGTTGTAACACCGTTTCGCCGATAGTCAAGGCGACCAGTCGGTCAGAGTTGAAATTCTGACAGGTCGCCCCCACCACTGTATTTGAACCACTGACGAACCTTTCTTTCC",
"AGGGCGGAACCCATAGCAGCCATCACCCAAATAACGGATATGTACACCCCCTCAAAAAACCTATCCCGACAAAAACACTAGGACTTTGTACCTGCGTAATATTTTGGCGTAAACTGCTGGCAAGCCTGTGAGGAGTTTCC",
"TCACTGACGAACGGTTTTTTCAGTGTATGATGGTCGATCTTCACGAAGCGTGACTGCGTCACAGGGCTGTCGCTTATTCACGGCAGACTCGGGGCCGGTCCTTTTACTTCAATCGTCACCCCTACATCAGGAGATATCCA",
"TTGCAACGTGCGGGCCGCGTCTCGGGCGGTTTGAGACGCTGCGTCTCATCCTGGGCAGTTGGTCAGCCCGCGCTTGTCCGACCCGACGCATGCGCGCTTAATAACGGGCATAACAACAAAGATCGAGAACCGGAGGCTTT",
"GCTGTGGCAGGGTCGATACGGGCGATGTGACAGTTTGTGCCACAAACGGTACAGCCTGTGACCAGTGGGTCGGCCTGGGATTGCATTGCCCGGTTCGCTGGGGGATGCTGGGGGTTCTCACGCAGGGAGAATAATAAGAA")

# Combine for labeling
label_promoters <- c(up_promoters)

# Subset data for labeling
label_genes <- res_S_W1vsS_W3 %>% filter(promoters %in% label_promoters)

# Volcano plot
ggplot(res_S_W1vsS_W3, aes(x = logFC, y = -log10(adj.P.Val), color = regulation)) +
  geom_point(alpha = 0.6) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "black") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black") +
  scale_color_manual(values = volcano_colors) +
  scale_x_continuous(limits = c(-5, 5), breaks = seq(-5, 5, 1)) +
  geom_text_repel(
    data = label_genes,
    aes(label = product.refseq),
    size = 4,
    box.padding = 0.5,
    max.overlaps = Inf
  ) +
  theme_minimal() +
  labs(
    title = "Volcano Plot: S_W1 vs S_W3",
    x = "log2 Fold Change",
    y = "-log10 Adjusted P-value"
  ) +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 20),
    axis.title = element_text(size = 20),
    axis.text = element_text(size = 20),
    plot.title = element_text(size = 20, hjust = 0.5)
  )




# 1. Filter for upregulated genes
res_SW1vsS_W3_up <- res_S_W1vsS_W3 %>% 
  filter(regulation == "Up")

res_SW1vsS_W3_down <- res_S_W1vsS_W3 %>% 
  filter(regulation == "Down")

write.csv(res_SW1vsS_W3_up, file = "res_SW1vsS_W3_up.csv", na="")
write.csv(res_SW1vsS_W3_down, file = "res_SW1vsS_W3_down.csv", na="")
```